<mat-sidenav-container class="h-[100vh]">
  <!-- Sidenav -->
  <mat-sidenav
    class="w-60! rounded-none!"
    #drawer
    [fixedInViewport]="true"
    [autoFocus]="false"
    mode="over"
    role="navigation"
  >
    <!-- Sidenav Toolbar -->
    <ng-container [ngTemplateOutlet]="toolbar"></ng-container>
    <!-- Sidenav Navigation -->
    <ng-container [ngTemplateOutlet]="navigation"></ng-container>
  </mat-sidenav>

  <!-- Content -->
  <mat-sidenav-content>
    <!-- Main Toolbar -->
    <ng-container [ngTemplateOutlet]="toolbar" [ngTemplateOutletContext]="{ fixed: true }"></ng-container>
    <!-- Main Navigation -->
    <div class="main-nav" [class.main-nav-full]="$isFullNav">
      <ng-container [ngTemplateOutlet]="navigation" [ngTemplateOutletContext]="{ fixed: true }"></ng-container>
    </div>
    <!-- Main Content -->
    <div class="main-content" [class.main-content-full]="$isFullNav">
      <router-outlet></router-outlet>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>

<ng-template #toolbar let-fixed="fixed">
  <mat-toolbar class="gap-2 {{ fixed ? 'sticky top-0 z-1000' : '' }}">
    <button (click)="$isLargeScreen ? toggleFullNav() : drawer.toggle()" matIconButton onclick="this.blur()">
      <mat-icon>menu</mat-icon>
    </button>
    <a class="ml-2 flex items-center gap-1 font-medium" routerLink="/">
      <mat-icon>logo_dev</mat-icon>
      <span>App</span>
    </a>
    @if (fixed) {
      <span class="grow"></span>
      @if (!auth.loading && auth.user) {
        <!-- User Logged In -->
        <button
          class="h-9! w-9! overflow-hidden! rounded-full! p-0!"
          [matMenuTriggerFor]="menu"
          (click)="menuPages.resetPages()"
          matIconButton
        >
          <img
            class="block h-full! w-full! object-cover"
            [src]="auth.user.profile?.avatar"
            alt="Profile picture"
            onerror="this.src='assets/images/default-user.png'"
          />
        </button>
      } @else if (!auth.loading) {
        <!-- Not Logged User -->
        <!-- Config Menu -->
        <div *var="{ section: 'main' } as configMenuOptions">
          <button [matMenuTriggerFor]="menu" (click)="menuPages.resetPages()" matIconButton>
            <mat-icon>more_vert</mat-icon>
          </button>
        </div>
        <!-- Sign In -->
        <a matButton="outlined" routerLink="/login">
          <mat-icon>account_circle</mat-icon>
          Sign in
        </a>
      } @else {
        <mat-spinner [diameter]="36"></mat-spinner>
      }
      <mat-menu class="mat-multi-page-menu menu" #menu="matMenu">
        <mat-multi-page-menu #menuPages="matMultiPageMenu">
          <menu-page>
            @if (!auth.loading && auth.user) {
              <div class="mat-menu-item-info flex! flex-row items-start gap-3 px-3 py-1">
                <img
                  class="block h-11 w-11 rounded-full"
                  [src]="auth.user.profile?.avatar"
                  alt="Profile picture"
                  onerror="this.src='assets/images/default-user.png'"
                />
                <div class="flex flex-col items-start justify-center">
                  <b class="h-6 text-xl font-medium">{{ auth.user.profile?.name }}</b>
                  {{ '@' + auth.user.username }}
                </div>
              </div>
              <mat-divider></mat-divider>
              <a mat-menu-item routerLink="/{{ auth.user.username }}">
                <mat-icon>person</mat-icon>
                <span>Profile</span>
              </a>
              <a (click)="logout()" mat-menu-item>
                <mat-icon>logout</mat-icon>
                <span>Sign out</span>
              </a>
              <mat-divider></mat-divider>
            }
            <button [matMenuPageLink]="'appearance'" mat-menu-item>
              <mat-icon>dark_mode</mat-icon>
              <span
                >Appearance:
                @switch (themeService.theme) {
                  @case ('light dark') {
                    Device theme
                  }
                  @case ('light') {
                    Light theme
                  }
                  @case ('dark') {
                    Dark theme
                  }
                }
              </span>
              <mat-icon class="mat-multi-page-menu-submenu">chevron_right</mat-icon>
            </button>
            <button mat-menu-item disabled>
              <mat-icon>translate</mat-icon>
              <span>Language: English</span>
              <mat-icon class="mat-multi-page-menu-submenu">chevron_right</mat-icon>
            </button>
            <button mat-menu-item disabled>
              <mat-icon>language</mat-icon>
              <span>Location: Argentina</span>
              <mat-icon class="mat-multi-page-menu-submenu">chevron_right</mat-icon>
            </button>
            <mat-divider></mat-divider>
            <a [disabled]="auth.loading || !auth.user" mat-menu-item routerLink="/settings">
              <mat-icon>settings</mat-icon>
              <span>Settings</span>
            </a>
            <mat-divider></mat-divider>
            <button mat-menu-item disabled>
              <mat-icon>feedback</mat-icon>
              <span>Send feedback</span>
            </button>
          </menu-page>
          <menu-page pageId="appearance" title="Appearance">
            <p class="text-muted mat-menu-item-info">Setting applies to this browser only</p>
            <button (click)="themeService.set('light dark')" mat-menu-item>
              @if (themeService.theme === 'light dark') {
                <mat-icon>check</mat-icon>
              }
              <span [class.mat-menu-item-noicon]="themeService.theme !== 'light dark'">Use device theme</span>
            </button>
            <button (click)="themeService.set('light')" mat-menu-item>
              @if (themeService.theme === 'light') {
                <mat-icon>check</mat-icon>
              }
              <span [class.mat-menu-item-noicon]="themeService.theme !== 'light'">Light theme</span>
            </button>
            <button (click)="themeService.set('dark')" mat-menu-item>
              @if (themeService.theme === 'dark') {
                <mat-icon>check</mat-icon>
              }
              <span [class.mat-menu-item-noicon]="themeService.theme !== 'dark'">Dark theme</span>
            </button>
          </menu-page>
        </mat-multi-page-menu>
      </mat-menu>
    }
  </mat-toolbar>
</ng-template>

<ng-template #navigation let-fixed="fixed">
  <mat-nav-list class="flex! flex-col! gap-2! p-3! {{ fixed ? 'h-full!' : 'h-[calc(100%-64px)]' }}">
    @for (link of navLinks; track link.route) {
      @if (link.toBottom) {
        <span class="grow"></span>
      } @else if (checkNavAccess(link)) {
        <a
          class="nav-item"
          #route="routerLinkActive"
          [routerLink]="link.route"
          [activated]="route.isActive"
          [routerLinkActiveOptions]="{ exact: link.exact || false }"
          [class.nav-item-sm]="fixed && (!$isLargeScreen || !$isFullNav)"
          (click)="drawer.close()"
          mat-list-item
          routerLinkActive
        >
          <mat-icon matListItemIcon>{{ link.icon }}</mat-icon>
          <span matListItemTitle>{{ link.label }}</span>
        </a>
      }
    }
  </mat-nav-list>
</ng-template>
