<mat-sidenav-container class="h-[100vh]">
  <!-- Sidenav -->
  <mat-sidenav #drawer class="w-60! rounded-none!" role="navigation" mode="over" [fixedInViewport]="true" [autoFocus]="false">
    <!-- Sidenav Toolbar -->
    <ng-container [ngTemplateOutlet]="toolbar"></ng-container>
    <!-- Sidenav Navigation -->
    <ng-container [ngTemplateOutlet]="navigation"></ng-container>
  </mat-sidenav>

  <!-- Content -->
  <mat-sidenav-content>
    <!-- Main Toolbar -->
    <ng-container [ngTemplateOutlet]="toolbar" [ngTemplateOutletContext]="{ fixed: true }"></ng-container>
    <!-- Main Navigation -->
    <div class="main-nav" [class.main-nav-full]="$isFullNav">
      <ng-container [ngTemplateOutlet]="navigation" [ngTemplateOutletContext]="{ fixed: true }"></ng-container>
    </div>
    <!-- Main Content -->
    <div class="main-content" [class.main-content-full]="$isFullNav">
      <router-outlet></router-outlet>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>

<ng-template #toolbar let-fixed="fixed">
  <mat-toolbar class="gap-2 {{ fixed ? 'sticky top-0 z-1000' : '' }}">
    <button matIconButton onclick="this.blur()" (click)="$isLargeScreen ? toggleFullNav() : drawer.toggle()">
      <mat-icon>menu</mat-icon>
    </button>
    <a class="ml-2 flex items-center gap-1 font-medium" routerLink="/">
      <mat-icon class="rounded-full" svgIcon="app-logo"></mat-icon>
      <span>{{ _title.appTitle }}</span>
    </a>
    @if (fixed) {
      <span class="grow"></span>
      @if (!_auth.loading && _auth.user) {
        <!-- User Logged In -->
        <button matIconButton class="h-9! w-9! overflow-hidden! rounded-full! p-0!" [matMenuTriggerFor]="menu" (click)="menuPages.resetPages()">
          <img
            class="block h-full! w-full! object-cover"
            alt="{{ 'shared.user.labels.profilePicture' | transloco }}"
            onerror="this.src='assets/images/default-user.png'"
            [src]="_auth.user.profile?.avatar"
          />
        </button>
      } @else if (!_auth.loading) {
        <!-- Not Logged User -->
        <!-- Config Menu -->
        <div *var="{ section: 'main' } as configMenuOptions">
          <button matIconButton [matMenuTriggerFor]="menu" (click)="menuPages.resetPages()">
            <mat-icon>more_vert</mat-icon>
          </button>
        </div>
        <!-- Sign In -->
        <a matButton="outlined" routerLink="/login">
          <mat-icon>account_circle</mat-icon>
          {{ 'nav.login' | transloco }}
        </a>
      } @else {
        <mat-spinner [diameter]="36"></mat-spinner>
      }
      <mat-menu #menu="matMenu" class="mat-multi-page-menu menu">
        <mat-multi-page-menu #menuPages="matMultiPageMenu">
          <menu-page>
            @if (!_auth.loading && _auth.user) {
              <div class="mat-menu-item-info flex! flex-row items-start gap-3 px-3 py-1">
                <img
                  class="block h-11 w-11 rounded-full"
                  alt="{{ 'shared.user.labels.profilePicture' | transloco }}"
                  onerror="this.src='assets/images/default-user.png'"
                  [src]="_auth.user.profile?.avatar"
                />
                <div class="flex flex-col items-start justify-center">
                  <b class="h-6 text-xl font-medium">{{ _auth.user.profile?.name }}</b>
                  {{ '@' + _auth.user.username }}
                </div>
              </div>
              <mat-divider></mat-divider>
              <a mat-menu-item routerLink="/{{ _auth.user.username }}">
                <mat-icon>person</mat-icon>
                <span>{{ 'menu.profile.title' | transloco }}</span>
              </a>
              <a mat-menu-item (click)="logout()">
                <mat-icon>logout</mat-icon>
                <span>{{ 'menu.signOut.title' | transloco }}</span>
              </a>
              <mat-divider></mat-divider>
            }
            <button mat-menu-item [matMenuPageLink]="'appearance'">
              <mat-icon>dark_mode</mat-icon>
              <span>
                {{ 'menu.appearance.title' | transloco }}:
                @switch (_theme.theme) {
                  @case ('light dark') {
                    {{ 'menu.appearance.deviceTheme' | transloco }}
                  }
                  @case ('light') {
                    {{ 'menu.appearance.lightTheme' | transloco }}
                  }
                  @case ('dark') {
                    {{ 'menu.appearance.darkTheme' | transloco }}
                  }
                }
              </span>
              <mat-icon class="mat-multi-page-menu-submenu">chevron_right</mat-icon>
            </button>
            <button mat-menu-item [matMenuPageLink]="'language'">
              <mat-icon>translate</mat-icon>
              <span>{{ 'menu.language.title' | transloco }}: {{ `lang.${_lang.lang}` | transloco }}</span>
              <mat-icon class="mat-multi-page-menu-submenu">chevron_right</mat-icon>
            </button>
            <!-- <button mat-menu-item disabled>
              <mat-icon>language</mat-icon>
              <span>Location: Argentina</span>
              <mat-icon class="mat-multi-page-menu-submenu">chevron_right</mat-icon>
            </button> -->
            <mat-divider></mat-divider>
            <a mat-menu-item routerLink="/settings" [disabled]="_auth.loading || !_auth.user">
              <mat-icon>settings</mat-icon>
              <span>{{ 'menu.settings.title' | transloco }}</span>
            </a>
            <mat-divider></mat-divider>
            <button mat-menu-item disabled>
              <mat-icon>feedback</mat-icon>
              <span>{{ 'menu.feedback.title' | transloco }}</span>
            </button>
          </menu-page>
          <menu-page title="{{ 'menu.appearance.title' | transloco }}" pageId="appearance">
            <p class="text-muted mat-menu-item-info">{{ 'menu.appearance.browserNote' | transloco }}</p>
            <button mat-menu-item (click)="_theme.set('light dark')">
              @if (_theme.theme === 'light dark') {
                <mat-icon>check</mat-icon>
              }
              <span [class.mat-menu-item-noicon]="_theme.theme !== 'light dark'">{{ 'menu.appearance.useDeviceTheme' | transloco }}</span>
            </button>
            <button mat-menu-item (click)="_theme.set('light')">
              @if (_theme.theme === 'light') {
                <mat-icon>check</mat-icon>
              }
              <span [class.mat-menu-item-noicon]="_theme.theme !== 'light'">{{ 'menu.appearance.lightTheme' | transloco }}</span>
            </button>
            <button mat-menu-item (click)="_theme.set('dark')">
              @if (_theme.theme === 'dark') {
                <mat-icon>check</mat-icon>
              }
              <span [class.mat-menu-item-noicon]="_theme.theme !== 'dark'">{{ 'menu.appearance.darkTheme' | transloco }}</span>
            </button>
          </menu-page>
          <menu-page title="{{ 'menu.language.select' | transloco }}" pageId="language">
            @for (lang of _lang.availableLangs; track lang) {
              <button mat-menu-item (click)="_lang.set(lang)">
                @if (_lang.lang === lang) {
                  <mat-icon>check</mat-icon>
                }
                <span [class.mat-menu-item-noicon]="_lang.lang !== lang">{{ `lang.${lang}` | transloco }}</span>
              </button>
            }
          </menu-page>
        </mat-multi-page-menu>
      </mat-menu>
    }
  </mat-toolbar>
</ng-template>

<ng-template #navigation let-fixed="fixed">
  <mat-nav-list class="flex! flex-col! gap-2! p-3! {{ fixed ? 'h-full!' : 'h-[calc(100%-64px)]' }}">
    @for (link of navLinks; track trackByNavLink(link)) {
      @if (link.type === 'toBottom') {
        <span class="grow"></span>
      } @else if (checkNavAccess(link)) {
        <a
          #route="routerLinkActive"
          mat-list-item
          class="nav-item"
          routerLinkActive
          [routerLink]="link.route"
          [activated]="route.isActive"
          [routerLinkActiveOptions]="{ exact: link.exact || false }"
          [class.nav-item-sm]="fixed && (!$isLargeScreen || !$isFullNav)"
          (click)="drawer.close()"
        >
          <mat-icon matListItemIcon>{{ link.icon }}</mat-icon>
          <span matListItemTitle>{{ link.label }}</span>
        </a>
      }
    }
  </mat-nav-list>
</ng-template>
