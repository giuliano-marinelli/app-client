@if (userLoading && !user) {
  <mat-spinner class="justify-self-center" diameter="60"></mat-spinner>
} @else if (!user) {
  <div class="flex flex-col items-center justify-self-center">
    <mat-icon class="icon-size-20 text-muted!">search_off</mat-icon>{{ 'messages.noAccount' | transloco }}
  </div>
} @else {
  <h1>
    {{ 'settings.emails.title' | transloco }}
    <mat-spinner class="ml-2 inline-block!" diameter="24" [hidden]="!userLoading"></mat-spinner>
  </h1>
  <mat-divider class="mt-2!"></mat-divider>
  <div class="mt-3" [class.loading]="userLoading">
    <ul class="border-muted rounded-lg border-1">
      @for (email of user.emails; let last = $last; track email.id) {
        <li class="border-muted p-4" [class.border-b-1]="!last">
          <div class="flex h-10 w-full items-center">
            <p class="font-medium wrap-anywhere">
              {{ email.address }}&nbsp;
              @if (user.primaryEmail?.id === email.id) {
                <span>
                  <span class="text-muted">â€“</span>&nbsp;
                  <span class="text-success">{{ 'settings.emails.hints.primary' | transloco }}</span>
                </span>
              }
            </p>
            @if (user.primaryEmail?.id !== email.id) {
              <button
                matIconButton
                class="error ml-auto"
                [disabled]="removeEmailSubmitLoading"
                (click)="confirmDelete.open(); $event.preventDefault()"
              >
                @if (removeEmailSubmitLoading === email.id) {
                  <mat-icon><mat-spinner diameter="17"></mat-spinner></mat-icon>
                } @else {
                  <mat-icon>delete</mat-icon>
                }
              </button>
              <confirm
                #confirmDelete
                requiredPasswordMessage="{{ 'settings.emails.confirm.passwordMessage' | transloco }}"
                [requiredPassword]="true"
                [requiredVerificationCode]="true"
                (confirm)="removeEmail($event, email)"
              ></confirm>
            }
          </div>
          @if (user.primaryEmail?.id === email.id && email.verified) {
            <p class="text-muted mt-3 text-sm">
              {{ 'settings.emails.hints.primaryDescription' | transloco }}
            </p>
          }
          <ul class="text-muted ml-4 list-[circle] text-sm">
            @if (email.verified) {
              <li class="mt-3">
                <span class="text-info">Verified</span><br />
                <span class="small">
                  {{ 'settings.emails.hints.verifiedDescription' | transloco }}
                </span>
              </li>
            }
            @if (!email.verified) {
              <li class="mt-3">
                <span class="text-warning">Unverified</span>
                <a class="text-info ms-4 cursor-pointer" (click)="sendVerificationEmail(email)"> Resend verification email </a><br />
                <span class="text-sm">
                  {{ 'settings.emails.hints.unverifiedDescription' | transloco }}
                  @if (user.primaryEmail?.id === email.id) {
                    <span>(unless it's your first email)</span>
                  }
                  .
                </span>
              </li>
            }
            @if (email.verified) {
              <li class="mt-3">
                <span>{{ 'settings.emails.hints.visibleEmail' | transloco }}</span
                ><br />
                <span class="text-sm">{{ 'settings.emails.hints.visibleEmailDescription' | transloco }}</span>
              </li>
            }
            @if (!email.verified && user.primaryEmail?.id !== email.id) {
              <li class="mt-3">
                <span>{{ 'settings.emails.hints.notVisibleEmail' | transloco }}</span
                ><br />
                <span class="text-sm">{{ 'settings.emails.hints.notVisibleEmailDescription' | transloco }}</span>
              </li>
            }
          </ul>
        </li>
      }
    </ul>
    <h2 class="mt-6">{{ 'settings.emails.addEmailForm.title' | transloco }}</h2>
    <mat-divider class="mt-2!"></mat-divider>
    <form [formGroup]="addEmailForm">
      <div class="md:max-w-100">
        <mat-form-field class="mt-3 w-full" appearance="outline" [floatLabel]="'always'" [subscriptSizing]="'dynamic'">
          <input matInput formControlName="address" autocomplete="off" placeholder="{{ user.primaryEmail?.address }}" />
          <mat-icon matPrefix>email</mat-icon>
          <mat-icon matSuffix>
            @if (addEmailAddress?.pending) {
              <mat-spinner diameter="20"></mat-spinner>
            }
          </mat-icon>
          <mat-error>
            <invalid-feedback
              name="Email"
              [control]="addEmailAddress"
              [messages]="{ notIncludedIn: ('settings.emails.errors.emailAlreadyAdded' | transloco) }"
            ></invalid-feedback>
          </mat-error>
        </mat-form-field>
        <button matButton="tonal" class="mt-3 whitespace-nowrap" [disabled]="!addEmailForm.valid || addEmailSubmitLoading" (click)="addEmail()">
          @if (addEmailSubmitLoading) {
            <mat-icon><mat-spinner diameter="17"></mat-spinner></mat-icon>
          }
          {{ 'settings.emails.addEmailForm.buttons.submit' | transloco }}
        </button>
      </div>
    </form>
    <h2 class="mt-6">{{ 'settings.emails.primaryEmailForm.title' | transloco }}</h2>
    <mat-divider class="mt-2!"></mat-divider>
    <p class="mt-3">
      <b>{{ user.primaryEmail?.address }}</b> {{ 'settings.emails.primaryEmailForm.hints.info' | transloco }}.
    </p>
    <form [formGroup]="primaryEmailForm">
      <div class="md:max-w-100">
        <mat-form-field class="mt-3 w-full" appearance="outline" [floatLabel]="'always'" [subscriptSizing]="'dynamic'">
          <mat-icon matPrefix>email</mat-icon>
          <mat-select formControlName="address" [compareWith]="compareById">
            @for (email of user.emails; track email.id) {
              <mat-option [value]="email" [disabled]="!email.verified"> {{ email.address }} {{ !email.verified ? '(unverified)' : '' }} </mat-option>
            }
          </mat-select>
        </mat-form-field>
        <button
          matButton="tonal"
          class="mt-3 whitespace-nowrap"
          [disabled]="!primaryEmailForm.valid || primaryEmailSubmitLoading"
          (click)="confirmChangePrimaryEmail.open()"
        >
          @if (primaryEmailSubmitLoading) {
            <mat-icon><mat-spinner diameter="17"></mat-spinner></mat-icon>
          }
          {{ 'settings.emails.primaryEmailForm.buttons.submit' | transloco }}
        </button>
        <confirm
          #confirmChangePrimaryEmail
          requiredPasswordMessage="Please enter your password to continue."
          [requiredPassword]="true"
          [requiredVerificationCode]="true"
          [onlyPassword]="true"
          [confirmColor]="'success'"
          (confirm)="changePrimaryEmail($event)"
        ></confirm>
      </div>
    </form>
  </div>
}
