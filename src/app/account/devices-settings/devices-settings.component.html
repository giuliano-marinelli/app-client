<div class="container mb-3">
  <div class="mt-3 mt-sm-0 border-bottom">
    <h2>
      Devices
      <a class="btn p-0 text-muted border-0" (click)="getSessions()" [class.disabled]="sessionsLoading">
        <fa-icon
          [icon]="'rotate-right'"
          size="lg"
          [class.fa-spin]="sessionsLoading"
          [class.fa-pulse]="sessionsLoading"
        ></fa-icon>
      </a>
    </h2>
  </div>
  <div #message_container></div>
  @if (!sessionsLoading && !sessions.length) {
    <div class="text-center mt-3">
      <fa-icon class="fa-fade" [icon]="'magnifying-glass'" size="3x"></fa-icon>
      <p class="mt-2">No devices found</p>
    </div>
  }
  @if (filter(sessions, { blockedAt: null, closedAt: null })?.length) {
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mt-0" [class.loading]="sessionsLoading">
      @for (session of sessions | filter: { blockedAt: null, closedAt: null }; track session) {
        <div class="col">
          <ng-container
            [ngTemplateOutlet]="sessionCard"
            [ngTemplateOutletContext]="{ session: session }"
          ></ng-container>
        </div>
      }
    </div>
  }
  @if (filter(sessions, { $or: { blockedAt: { $not: null }, closedAt: { $not: null } } })?.length) {
    <div [class.loading]="sessionsLoading">
      <div class="mt-3 border-bottom">
        <h4>Closed sessions</h4>
      </div>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mt-0">
        @for (
          session of sessions | filter: { $or: { blockedAt: { $not: null }, closedAt: { $not: null } } };
          track session
        ) {
          <div class="col">
            <ng-container
              [ngTemplateOutlet]="sessionCard"
              [ngTemplateOutletContext]="{ session: session }"
            ></ng-container>
          </div>
        }
      </div>
    </div>
  }
</div>

<ng-template #sessionCard let-session="session">
  <div class="card bg-dark-subtle">
    @if (submitLoading.includes(session.id)) {
      <div class="overlay d-flex align-items-center text-center text-body rounded">
        <fa-icon class="flex-fill" [icon]="'spinner'" class="fa-spin fa-pulse" size="2x"></fa-icon>
      </div>
    }
    <div class="card-body">
      <div class="card-text">
        <div class="d-flex flex-row">
          <div>
            <fa-icon [icon]="deviceTypeIcon(session.device?.type)" size="2x"> </fa-icon>
          </div>
          <div class="flex-fill text-center">
            {{
              session.device?.brand
                ? session.device?.brand + ' ' + (session.device?.model ? session.device?.model : '')
                : session.device?.os
                  ? session.device?.os
                  : 'Unknown'
            }}
          </div>
          @if (session.token != auth.getToken() && !session.blockedAt && !session.closedAt) {
            <div ngbDropdown display="dynamic" placement="bottom-end" autoClose="true">
              <a class="btn p-0">
                <fa-icon class="no-dropdown-arrow" [icon]="'ellipsis-vertical'" ngbDropdownToggle></fa-icon>
              </a>
              <div class="dropdown-menu shadow-sm" ngbDropdownMenu>
                <a ngbDropdownItem class="small pe-pointer" (click)="closeSession(session)">
                  <fa-icon [icon]="'sign-out'"></fa-icon> Close session
                </a>
              </div>
            </div>
          }
        </div>
        @if (session.blockedAt) {
          <div class="mt-1 text-danger text-end"><fa-icon [icon]="'lock'"></fa-icon> Blocked</div>
        }
        @if (session.closedAt && !session.blockedAt) {
          <div class="mt-1 text-secondary text-end"><fa-icon [icon]="'circle-xmark'"></fa-icon> Closed</div>
        }
        @if (session.token == auth.getToken()) {
          <div class="mt-1 text-success text-end"><fa-icon [icon]="'circle-check'"></fa-icon> Current device</div>
        }
        @if (session.device?.ip) {
          <div class="mt-1 d-flex flex-row text-muted">
            <fa-icon class="me-1" [icon]="'globe'"></fa-icon>
            <div>{{ session.device?.ip }}</div>
          </div>
        }
        <div class="mt-1 pt-1 small border-top">
          <b>First login:</b> {{ session.createdAt | amLocal | amDateFormat: 'LLL' }}
        </div>
        <div class="mt-1 small">
          <b> {{ session.closedAt || session.blockedAt ? 'Last' : 'Recent' }} activity: </b>
          {{ session.updatedAt | amLocal | amTimeAgo }}
        </div>
        @if (session.device?.client) {
          <div class="mt-1 pt-1 d-flex flex-row border-top">
            <fa-icon class="me-1" [icon]="browserIcon(session.device?.client)"></fa-icon>
            <div>{{ session.device?.client }}</div>
          </div>
        }
      </div>
    </div>
  </div>
</ng-template>
